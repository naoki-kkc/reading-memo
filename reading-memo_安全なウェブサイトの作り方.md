読書メモ@安全なウェブサイトの作り方
https://www.ipa.go.jp/security/vuln/websecurity.html

# ウェブアプリケーションのセキュリティ実装

## SQLインジェクション

SQL文の組み立てに問題がある場合に発生する脆弱性。

### 発生しうる脅威には以下がある。

- DB内の非公開情報の閲覧
    - 情報漏洩
- DB内の情報の改竄、消去
    - Webサイトの改竄
    - パスワード変更
    - システム停止
- 認証回避による不正ログイン
    - 許可されている全ての操作が不正に実行される
- ストアドプロシージャを利用したOSコマンドの実行
    - システムの乗っ取り
    - 踏み台への悪用

### 本脆弱性への注意が必要なウェブサイトは以下である。

- データベースを設置している
    - 個人情報を格納している場合、特に注意が必要

### 本脆弱性の根本的解決方法は以下である。

- SQL文の組み立てをプレースホルダで実装する
    - コンパイルしたSQL文にデータベースエンジンがバインドする静的プレースホルダか、アプリケーション側のデータベースライブラリで値をエスケープしてバインドする動的プレースホルダ
        - 原理的に脆弱性を排除できる静的プレースホルダの方が安全
- SQL文の組み立てを文字列連結で行う場合、データベースエンジンのAPIでエスケープ処理を行う
    - エスケープ対象はデータベースエンジンごとに異なるため、ライブラリで提供されている専用APIを用いる
- ウェブアプリに渡すパラメータにSQL文を含まない
    - hidden等でSQL文をフロントエンドに渡さない

### 本脆弱性の保険的対策は以下である。

- エラーメッセージをブラウザに表示しない
    - エラーメッセージからデータベースの種類、エラーの原因、実行エラー時のSQLなどが読み取れる
        - これらは攻撃の手がかりとなる可能性が高い
- データベース接続に使用するアカウントに適切な権限を割り当てる
    - 実行される命令文を洗い出し、必要最小限の権限を割り当てる
    - 必要以上に高い権限を与えると被害が深刻化する

## OSコマンドインジェクション

外部からの攻撃でサーバーのOSコマンドが不正に実行されてしまった場合に発生する脆弱性。

### 発生しうる脅威には以下がある。

- サーバー内のファイル閲覧、改竄、削除
    - 重要情報の漏洩
    - 設定ファイルの改竄
- 不正なシステム操作
    - OSのシャットダウン
    - ユーザーアカウントの追加、変更
- 不正なプログラムのダウンロード
    - ウイルス、ワーム、ボットの感染
    - バックドアの設置
- 攻撃の踏み台
    - サービス不能攻撃
    - システム攻略のための調査
    - 迷惑メールの送信

### 本脆弱性への注意が必要なウェブサイトは以下である。

- 外部プログラムを呼び出し可能な関数を使用している
    - Perlのopen()、system()、eval()
    - PHPのexec()、passthru()、shell_exec()、system()、popen()

### 本脆弱性の根本的解決方法は以下である。

- シェル起動が可能な言語機能を利用しない

### 本脆弱性の保険的対策は以下である。

- シェル起動が可能な言語機能を利用する場合、引数チェックを行い、許可した処理のみ実行する
    - コマンドを全て洗い出し、それ以外は一切許可しない、ホワイトリスト方式で実装する

## ディレクトリ・トラバーサル

外部からのパラメータでウェブサーバ内のファイル名を指定している場合に発生する脆弱性。

### 発生しうる脅威には以下がある。

- サーバー内のファイル閲覧、改竄、削除
    - 重要情報の漏洩
    - 設定ファイルの改竄

### 本脆弱性への注意が必要なウェブサイトは以下である。

- 外部からのパラメータでファイル名を直接指定している

### 本脆弱性の根本的解決方法は以下である。

- 外部からのパラメータでファイル名を直接指定しない
    - パラメータが改変され、想定しないファイルが閲覧される可能性がある
    - ファイル名の直接指定が本当に必要か検討する
- 開くファイルは固定ディレクトリかつパラメータがファイル名のみとする
    - 「固定ディレクトリ+パラメータのファイル名」でパスを構成する
    - パラメータをファイルパスからファイル名だけ取り出す関数に通す

### 本脆弱性の保険的対策は以下である。

- ファイルへのアクセス権限を正しく設定する
    - 任意のディレクトリを開こうとしてもアクセス権がなければ開けない
- ファイル名のチェックを行う
    - ファイル名からパス名解釈できる文字列を検出した時点で処理を中止する
    - 対象文字列は「/」「../」「..¥」等
        - URLエンコードした「%2F」「..%2F」「..%5C」なども有効になる可能性があるため、チェックのタイミングに注意


## セッション管理の不備

セッションIDの発酵や管理に不備がある場合に発生する脆弱性。
また、「セッションIDの固定化」と呼ばれる攻撃手法もある。

### 発生しうる脅威には以下がある。

- 攻撃者が利用者になりすまし、利用者本人に許可されている操作を不正に行う
    - ログインした利用者のみが利用可能なサービスの悪用
        - 不正な送金
        - 意図しない商品購入
        - 意図しない退会処理
    - ログインした利用者のみが編集可能な情報の改竄
        - 各種設定の変更
        - パスワード変更
        - 掲示板への不適切な書き込み
    - ログインした利用者のみが閲覧可能な情報の閲覧
        - 個人情報の非公開部分を不正に閲覧
        - メールの閲覧

### 本脆弱性への注意が必要なウェブサイトは以下である。

- なんらかのログイン機能を持つサイト
    - 金銭処理が発生するサイトや非公開情報を扱うサイトではより被害が大きくなる

### 本脆弱性の根本的解決方法は以下である。

- 予測困難なセッションID
    - 生成アルゴリズムに暗号論的擬似乱数生成器を用いて、予測を困難にする
    - セッション管理機能が提供されている製品を利用する場合、自前で生成せずに当該機能を利用する
- URLにセッションIDを格納しない
    - Referrerで別サイトに送信されるので、攻撃者に悪用される可能性がある
        - Cookieに格納するか、POSTでhiddenパラメータに格納して受け渡す
- HTTPS通信が可能な場合、Cookieにsecure属性を加える
    - secure属性がないとHTTPでも送信されてしまい、盗聴される危険性がある
- ログイン成功後、新たなセッションを開始する
    - 既存のセッションを無効化することで、セッションIDの固定化攻撃を防ぐ
- ログイン成功後、セッションIDとは別の秘密情報を発行し、ページ遷移時に値を確認する
    - 暗号論的擬似乱数生成器で生成した値をCookieにセットし、ページ遷移時に検証する
    - 以下の場合、対応不要
        - 前述の「新たなセッションを開始する」が実装されている
        - セッションIDをログイン成功後のみ発行する

### 本脆弱性の保険的対策は以下である。

- セッションIDを固定値にしない
    - 利用者ごと、ログインごとに発行し直す
- セッションIDをCookieにセットする際、有効期限の設定に注意する
    - 必要以上の期間Cookieがブラウザに保存されないようにする
    - `expires`を省略し、ブラウザ終了時に破棄することも可能

## XSS

ウェブページの出力処理に問題がある場合に発生する脆弱性。

### 発生しうる脅威には以下がある。

- 本物サイト上に偽のページが表示される
    - 偽情報の流布
    - フィッシング詐欺による重要情報の漏洩
- ブラウザが保存しているCookieを取得される
    - CookieにセッションIDが格納されている場合、なりすましが可能
    - Cookieに個人情報が格納されている場合、当該情報の漏洩
- 任意のCookieをブラウザに保存させられる
    - 任意のセッションIDが送り込まれ、セッションIDの固定化攻撃に悪用可能

### 本脆弱性への注意が必要なウェブサイトは以下である。

- あらゆるサイト
    - Cookieを利用してセッション管理を行っているサイトやフィッシング詐欺の攻撃ターゲットになりやすいページ(ログイン、個人情報入力)を持つサイトは攻撃ターゲットになりやすい

### HTMLテキストの入力を許可しない場合

#### 本脆弱性の根本的解決方法は以下である。

- 出力する全要素にエスケープ処理を施す
    - 外部から入力されたパラメータ、DBから取得した文字列、ファイルから読み込んだ文字列、演算によって生成された文字列は必須
        - 要不要かかわらずエスケープ処理を施すと対策漏れを防止できる
- URL出力時は「http://」か「https://」で始まるURLのみ許可
    - 「`javascript:`」から始まるURLはスクリプトが埋め込まれる可能性がある
- 「`<script>`」要素の内容を動的に生成しない
    - スクリプトが安全かの判断は難しいため、一切の生成を許可しない方針が適切
- スタイルシートを任意のサイトから取り込まない
    - `expression()`を利用して記述したスクリプトが埋め込まれる可能性がある
        - スタイルシートからスクリプトだけを確実に排除するのは難しいので、「指定可能である仕様」自体を避ける

#### 本脆弱性の保険的対策は以下である。

- すべての入力値についてチェックを行い、エラーの場合は再入力を求める
    - 有効になる状況は限定的で、完全な対策にはならない。

### HTMLテキストの入力を許可する場合

#### 本脆弱性の根本的解決方法は以下である。

- 入力されたHTMLテキストから構文解析木を生成し、スクリプトが含まれない要素のみを抽出する
    - ホワイトリスト方式で許可する要素のみ抽出する

#### 本脆弱性の保険的対策は以下である。

- 入力されたHTMLテキストからスクリプトに該当する文字列を排除する
    - 「`<script>`」や「`javascript:`」といった文字列に適当な文字列を付与して無効化する
        - 適当な文字列を付与して上記文字列が成立することもあるため、根本的対策ではない
        - パターンマッチングで危険な文字列を完全に抽出できない可能性もある


### 全てのアプリケーション共通

#### 本脆弱性の根本的解決方法は以下である。

- HTTPレスポンスヘッダのContent-Typeに文字コードを指定する
    - 埋め込まれた文字列が特定の文字コードでエンコードされるとスクリプトとして認識することがある

#### 本脆弱性の保険的対策は以下である。

- 発行したCookieにHttpOnly属性を設定し、TRACEメソッドを無効化する
    - HttpOnly属性が設定されたCookieはHTMLテキスト内スクリプトからアクセスできない
    - ブラウザによって実装に差があるため、有効に働かないこともある
- XSSの脆弱性対策として有効なブラウザ機能を有効化する
    - XSSのブロックを試みるブラウザの機能はユーザーが無効化できる
    - `X-XSS-Protection`
        - ブラウザのXSSフィルタ設定を有効にするパラメータ。受信したブラウザはXSSのブロックを試みる機能が有効になる。
    - `Content Security Policy`
        - ブラウザで起こりうる問題を緩和するセキュリティの追加レイヤー。反射型XSS攻撃を防止するには「`reflect-xss`」を指定する。

## CSRF

利用者の意図したリクエストかどうか確認しない場合に発生する脆弱性。

### 発生しうる脅威には以下がある。

- ログイン後の利用者のみが利用可能なサービスの悪用
    - 不正な送金
    - 利用者が意図しない商品購入
    - 利用者が意図しない退会処理
- ログイン後の利用者のみが編集可能な情報の改竄
    - 各種設定の不正な変更

### 本脆弱性への注意が必要なウェブサイトは以下である。

- Cookieを用いたセッション処理が存在する
- Basic認証
- SSLクライアント認証

また、特に被害が大きくなるのは以下の機能を持つウェブサイトである。

- 金銭処理が発生するサイト
- ログイン機能を持つサイト

### 本脆弱性の根本的解決方法は以下である。

- 処理を実行する前のページで自動生成した第2セッションIDをhiddenパラメータ保持して、処理を実行するページへPOSTでアクセスし、その値が正しいか確認する
    - 第2セッションIDは暗号論的擬似乱数生成器を用いて生成し、第三者に予測困難である必要がある
- Refererが正しいリンク元か確認し、正しい場合のみ処理を実行する
    - Refererから本来の画面遷移をしているか判断する
        - リンク元が不正な場合、またはRefererが空の場合実行できないようにする
            - ブラウザやパーソナルファイアウォールによってRefererが送信されない場合は不都合が生じる
        - 攻撃者がウェブサイト上に罠を設置した場合には対応できない
- 処理を実行する直前でパスワードの入力を求め、入力されたパスワードが正しい場合のみ処理を実行する
    - 画面の仕様を変更する必要がある

### 本脆弱性の保険的対策は以下である。

- 重要な操作を行った際、登録済みメールアドレスを自動送信する
    - 攻撃があった際に利用者が異変に気付きやすい

## HTTPヘッダインジェクション

外部から渡されるパラメータをHTTPレスポンスヘッダに挿入する場合に発生する脆弱性。

### 発生しうる脅威には以下がある。

- XSSによって発生しうる脅威と同じ脅威
    - 任意のレスポンスボディを注入された場合、任意のスクリプトを埋め込まれる可能性がある
- 任意のCookie発行
    - Set-Cookieヘッダを注入された場合、任意のCookieが発行される可能性がある
- キャッシュサーバのキャッシュ汚染
    - 複数のレスポンスに分割し、任意のレスポンスボディをリバースプロキシにキャッシュさせることでキャッシュ汚染を引き起こす

### 本脆弱性への注意が必要なウェブサイトは以下である。

- 外部から渡されるパラメータでHTTPレスポンスヘッダのフィールド値(Locationヘッダ、Set-Cookieヘッダ)を生成している場合
    - Cookieを利用してログインのセッション管理を行っているサイト
    - リバースプロキシとしてキャッシュサーバを構築しているサイト

### 本脆弱性の根本的解決方法は以下である。

- ヘッダ出力を自作せず、実行環境や言語に用意されているAPIを使用する
    -  HTTPヘッダは改行で区切られる構造なので、APIを使用することで改行を無効化する
- (上記のAPIで改行コードを適切に処理できない場合、)改行を許可しないよう適切な処理を実装する
    - 改行の後に空白を入れて継続行として処理する
    - 改行コード以降の文字を削除する
    - 入力値に改行が含まれていた場合、処理を注視する

### 本脆弱性の保険的対策は以下である。

- 外部からの入力は改行コードを削除する
    - 入力がtextareaではない場合、全ての改行コードと制御コードを削除することを検討する

## メールヘッダインジェクション

入力値を管理者にメールを送信している場合に発生する脆弱性。

### 発生しうる脅威には以下がある。

- メールの第三者中継
    - 迷惑メールの送信に悪用される

### 本脆弱性への注意が必要なウェブサイトは以下である。

- 利用者が入力した内容を管理者宛にメールで送信する

### 本脆弱性の根本的解決方法は以下である。

- メールヘッダを肯定し、入力値はメール本文に出力する
    - To、Cc、Bcc、Subject等のメールヘッダを外部から入力する場合、余分な改行が差し込まれることになる
- (メールヘッダを固定できない場合、)実行環境や言語に用意されているメール送信用APIを使用する
    - 改行コードが適切にエスケープされるはず
- HTMLで宛先を指定しない
    - To、Cc、Bccをhiddenパラメータで持っていると、画面側で書き換えが可能

### 本脆弱性の保険的対策は以下である。

- 外部からの入力は改行コードを削除する
    - 入力がtextareaではない場合、全ての改行コードと制御コードを削除することを検討する

## クリックジャッキング

細工された外部サイトを閲覧することで利用者に誤操作を誘発させる脆弱性。

### 発生しうる脅威には以下がある。

- ログイン後の利用者のみが利用可能なサービスの悪用
    - 利用者が意図しない情報発信
    - 利用者が意図しない退会処理
- ログイン後の利用者のみが編集可能な情報の改竄
    - 利用者が意図しない公開範囲の変更

### 本脆弱性への注意が必要なウェブサイトは以下である。

- ログイン後の利用者がマウスのみで利用可能な機能が存在する

### 本脆弱性の根本的解決方法は以下である。

- HTTPレスポンスヘッダに`X-Frame-Options`を出力し、他ドメインのサイトからframe/iframe要素による読み込みを制限する
    - 一部の設定値はブラウザによって動作が異なるため、対応状況の確認が必要
- 処理を実行する直前でパスワードの入力を求め、入力されたパスワードが正しい場合のみ処理を実行する
    - 画面設計の仕様変更を必要とする

### 本脆弱性の保険的対策は以下である。

- 重要な処理は一連の操作をマウスのみで実行できないよう設計する
    - クリックジャッキングでは複雑な操作をさせることは不可能
    - キーボード操作を挟むこむことで攻撃の成功率を下げる

## バッファオーバーフロー

入力されたデータを適切に扱わない場合、本来のメモリ領域を超えた領域を上書きし、意図しないコードが実行される脆弱性。

### 発生しうる脅威には以下がある。

- プログラムの異常終了
    - 意図しないサービスの停止
- 任意のコード実行
    - ウイルス、ワーム、ボットへの感染
    - バックドアの設置
    - 他システムへの攻撃
    - 重要情報の漏洩

### 本脆弱性への注意が必要なウェブサイトは以下である。

- 直接メモリを操作できる言語で開発されている場合
    - 現在のウェブアプリケーションのほとんどは直接メモリを操作できない言語で書かれている
        - ライブラリや言語本体にバッファオーバーフロー脆弱性があることもある

### 本脆弱性の根本的解決方法は以下である。

- 直接メモリにアクセスできない言語で開発を行う
- 直接メモリにアクセスする言語を使う場合、当該箇所を最小限にする
    - 内部でメモリにアクセスする言語を呼び出す箇所を最小限にする
    - 呼び出し部分の脆弱性がないことを集中的に確認する
- 脆弱性が修正されたバージョンのライブラリを使用する
    - 古いライブラリにはバッファオーバーフロー脆弱性が存在することがある

## アクセス制御の欠落

不適切な設計で作成された場合に発生する脆弱性。

### 本脆弱性の根本的解決方法は以下である。

- パスワード等の秘密情報の入力を必要とする認証機能を設ける
    - 個人情報を閲覧するにもかかわらずメールアドレスのみで認証可能、という設計がなされた実例がある

## 認可制御の欠落

不適切な設計で作成された場合に発生する脆弱性。

### 本脆弱性の根本的解決方法は以下である。

- 認証機能に加え、他人になりすましてアクセスできないようにする

# ウェブサイトの安全性向上のための取り組み

本章は主に運用レベルの解決や対策を述べる。

##　ウェブサーバに関する対策

- 使用しているOS/ソフトウェアの脆弱性情報を継続的に入手し、脆弱性への対処を行う
    - 脆弱性をついた攻撃を受けると、不正侵入されてしまう場合がある
- リモート操作の認証方法として、パスワード認証以外の方法を検討する
    - パスワードのみで認証をしている場合、総当たり攻撃等で突破される可能性がある
- パスワード認証を利用する場合、十分に複雑な文字列を設定する
- 不要なサービスやアカウントを停止または削除する
    - 不要なサービスは管理が十分でなく、脆弱性が突かれる可能性がある
    - 不要なアカウントは管理が十分でなく、不正利用される可能性がある
- 公開を想定しないファイルをウェブ公開用ディレクトリに配置しない
    - 外部からURLを直接指定することで閲覧される可能性がある

## DNSに関する対策

- ドメイン名及DNSサーバの登録状況を調査し、必要に応じて対処する
    - 問題のある運用や設定はドメイン名乗っ取りに繋がる
- DNSソフトウェアの更新や設定を見直す
    - 攻撃されたり、攻撃時の被害が大きくなる
    - 外部に委託している場合は委託先へ連絡が必要

## ネットワーク盗聴への対策

- 重要な情報を取り扱う際は通信経路を暗号化
    - SSLやTLSで通信を暗号化する(URLが`https`から始まるようにする)
    - 必ず`https`になるよう、HSTSが規定された
        - HTTPレスポンスヘッダに`Strict-Transport-Security`を含めるよう設定
        - 2回目以降は自動的に`https`で接続するようになる
        - サイト全体が`https`になっている必要がある
- 重要な情報はメールを送付せず`https`の画面に表示
    - 重要な情報を送る際は通信の暗号化か重要な情報の暗号化が必要
        - 前者は`https`、後者は`S/MIME`や`PGP`
    - メールは平文で送付されるため、盗聴可能
        - 暗号化技術はあるが、利用者側にプライベートキーが必要なのは非現実的
- ウェブサイト運営者がメールで受け取る重要情報を暗号化する
    - メール通知するなら`S/MIME`や`PGP`で暗号化

## フィッシング詐欺を助長しないための対策

- EV SSL証明書を取得し、サイト運営者を証明する
    - ブラウザのアドレスバーが緑になり、組織名が表示される
- フレームを利用する場合、子フレームのURLを外部パラメータから生成しない
    - 任意のURLを表示されるよう罠が仕掛けられると、表示上は本物でも罠サイトが表示される
- リダイレクト機能は自ドメインと共通のドメインのみ許可する
    - 罠サイトへの誘導を防ぐ

## パスワードに関する対策

- 初期パスワードは推測が困難な文字列を発行する
    - 暗号論的擬似乱数生成器を使用して規則性をなくす
        - 英数字、記号を含めるとなお良い
        - 規則性を排除する
- パスワードの変更には原稿パスワードの入力を求める
- 入力後の応答メッセージが認証情報を推測する手掛かりにならない工夫をする
- 入力フィールドではパスワードを伏字で設定する
- パスワードを保存する際はソルト付きハッシュ値で
    - 平文で保存すると漏洩した場合の被害が甚大

## WAFによるウェブアプリケーションの保護

実装面では脆弱性を作り込まないこと、発見したら早期に修正することが重要である。
脆弱性を悪用する攻撃への運用面からの対策として、WAF(Web Application Firewall)の使用がある。
開発や運用の状況によっては、実装面の対策より有効な場合がある。

WAFはHTTP/HTTPS通信を検査し、不正な通信を自動的に遮断するソフトウェア/ハードウェアで、以下のような効果を期待できる。

- 脆弱性を悪用する攻撃からの防御
- 脆弱性を悪用した攻撃の検出
- 複数のウェブアプリケーションへの攻撃を一括で防御

WAFが有効な状況として、以下が挙げられる。

- 開発者に回収を依頼できない
- 改修できないウェブアプリケーションに脆弱性がある

WAFはHTTP/HTTPSを検出パターンに基づき機械的に検査する。
WAFが正常であると判断した通信はそのままウェブアプリケーションへ送信し、悪質であると判定した通信は設定された処理(管理者への警告通知、当該通信の遮断)を行う。

WAFは機械的に検査している都合上、判定エラーが生じる可能性がある。
判定エラーには以下の2種類がある。

- 偽陽性(false positive)
    - 正常な通信が遮断される
        - 可用性が損なわれる
    - 安易な検出パターンを定義したため発生することがある
- 偽陰性(false negative)
    - 悪質な通信から防御できない
    - 不正なHTTP通信を判定する検出パターンを適切に定義する
        - まずは不正を検出しても遮断しないように設定し、監視するだけのテスト期間を設けてWAFの動作確認を行う

